<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>loompy.loompy &#8212; loompy 3.0.6 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-light navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html"><span><img src="../../_static/Loom_icon.png"></span>
          Loom</a>
        <span class="navbar-text navbar-version pull-left"><b>3.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="http://loompy.org">loompy.org</a></li>
                <li><a href="https://github.com/linnarsson-lab/loompy">GitHub</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Loompy documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation/index.html#requirements">Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation/index.html#easy-installation">Easy installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation/index.html#from-source">From source</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../installation/index.html#getting-started">Getting Started</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../semantics/index.html">Understanding the semantics of loom files</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../semantics/index.html#connecting-not-loading-and-saving">Connecting, not loading and saving</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../semantics/index.html#reading-and-writing">Reading and writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../semantics/index.html#efficient-indexing-and-compression">Efficient indexing and compression</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../semantics/index.html#matrix-and-attributes">Matrix and attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../semantics/index.html#data-types">Data types</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kallisto/index.html">Create from fastq</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../kallisto/index.html#the-loompy-command-line-tool">The <code class="docutils literal notranslate"><span class="pre">loompy</span></code> command-line tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../kallisto/index.html#using-the-loompy-fromfq-command">Using the <code class="docutils literal notranslate"><span class="pre">loompy</span> <span class="pre">fromfq</span></code> command</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../apiwalkthrough/index.html">API Walkthrough</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../apiwalkthrough/index.html#creating-and-connecting">Creating and connecting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../apiwalkthrough/index.html#manipulate-data">Manipulate data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook/index.html">Cookbook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#working-with-a-newly-created-file">Working with a newly created file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#loading-attributes-from-pandas">Loading attributes from Pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#combining-data-using-scan-and-new">Combining data using scan() and new()</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cookbook/index.html#fitting-an-incremental-pca">Fitting an incremental PCA</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions/index.html">Conventions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../conventions/index.html#single-analysis-per-file">Single analysis per file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../conventions/index.html#orientation">Orientation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../conventions/index.html#attribute-naming-conventions">Attribute naming conventions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../format/index.html">Loom file format specs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#versions">Versions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#hdf5-concepts">HDF5 concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#standards">Standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#specification">Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#datatypes">Datatypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../format/index.html#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../fullapi/index.html">Complete API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/create.html">create (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/new.html">new (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/create_from_fastq.html">create_from_fastq (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/create_from_cellranger.html">create_from_cellranger (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/connect.html">connect (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/combine.html">combine (function)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/loompy.html">LoomConnection (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/layer_manager.html">LayerManager (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/memory_loom_layer.html">MemoryLoomLayer (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/loom_layer.html">LoomLayer (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/view_manager.html">ViewManager (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/loom_view.html">LoomView (class)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../fullapi/loom_validator.html">LoomValidator (class)</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><div class="list-group">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Loompy documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../semantics/index.html">Understanding the semantics of loom files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kallisto/index.html">Create from fastq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../apiwalkthrough/index.html">API Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook/index.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../conventions/index.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../format/index.html">Loom file format specs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fullapi/index.html">Complete API Reference</a></li>
</ul>

</div>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for loompy.loompy</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2015 Sten Linnarsson</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Redistribution and use in source and binary forms, with or without</span>
<span class="c1"># modification, are permitted provided that the following conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#   list of conditions and the following disclaimer.</span>
<span class="c1">#</span>
<span class="c1"># * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#   this list of conditions and the following disclaimer in the documentation</span>
<span class="c1">#   and/or other materials provided with the distribution.</span>
<span class="c1">#</span>
<span class="c1"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c1"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c1"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE</span>
<span class="c1"># DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE</span>
<span class="c1"># FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="c1"># DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="c1"># SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER</span>
<span class="c1"># CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="c1"># OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="c1"># OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copyfile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy_groupies.aggregate_numpy</span> <span class="k">as</span> <span class="nn">npg</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="k">import</span> <span class="n">mmread</span>

<span class="kn">import</span> <span class="nn">loompy</span>
<span class="kn">from</span> <span class="nn">loompy</span> <span class="k">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">timestamp</span>


<div class="viewcode-block" id="LoomConnection"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection">[docs]</a><span class="k">class</span> <span class="nc">LoomConnection</span><span class="p">:</span>
	<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">	A connection to a Loom file on disk. Typically LoomConnection objects are created using one of the</span>
<span class="sd">	functions on the loompy module, such as :func:`loompy.connect` or :func:`loompy.new`. LoomConnection</span>
<span class="sd">	objects are context managers and should normally be</span>
<span class="sd">	wrapped in a ``with`` block:</span>

<span class="sd">	.. highlight:: python</span>
<span class="sd">	.. code-block:: python</span>

<span class="sd">		import loompy</span>
<span class="sd">		with loompy.connect(&quot;mydata.loom&quot;) as ds:</span>
<span class="sd">			print(ds.ca.keys())</span>

<span class="sd">	Inside the ``with`` block, you can access the dataset (here using the variable ``ds``). When execution</span>
<span class="sd">	leaves the ``with`` block, the connection is automatically closed, freeing up resources.</span>
<span class="sd">	&#39;&#39;&#39;</span>
<div class="viewcode-block" id="LoomConnection.__init__"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.__init__">[docs]</a>	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Establish a connection to a Loom file.</span>

<span class="sd">		Args:</span>
<span class="sd">			filename:			Name of the .loom file to open</span>
<span class="sd">			mode:				read/write mode, accepts &#39;r+&#39; (read/write) or</span>
<span class="sd">								&#39;r&#39; (read-only), defaults to &#39;r+&#39; without arguments,</span>
<span class="sd">								and to &#39;r&#39; with incorrect arguments</span>
<span class="sd">			validate:			Validate that the file conforms with the Loom specification</span>
<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;File &#39;</span><span class="si">{filename}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
		<span class="c1"># make sure a valid mode was passed</span>
		<span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;r+&#39;</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be either &#39;r&#39; or &#39;r+&#39;&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>  <span class="c1">#: Path to the file (as given when the LoomConnection was created)</span>

		<span class="c1"># Validate the file</span>
		<span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
			<span class="n">lv</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomValidator</span><span class="p">()</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">lv</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lv</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{filename}</span><span class="s2"> does not appear to be a valid Loom file according to Loom spec version &#39;</span><span class="si">{lv.version}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">if</span> <span class="s2">&quot;matrix&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s2">&quot;/matrix&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1">#: Shape of the dataset (n_rows, n_cols)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">ViewManager</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1">#: Create a view of the file by slicing this attribute, like ``ds.view[:100, :100]``</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#: Row attributes, dict-like with np.ndarray values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#: Column attributes, dict-like with np.ndarray values</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">GlobalAttributeManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>  <span class="c1">#: Global attributes</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">GraphManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#: Row graphs, dict-like with values that are :class:`scipy.sparse.coo_matrix` objects</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">GraphManager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1">#: Column graphs, dict-like with values that are :class:`scipy.sparse.coo_matrix` objects</span>

		<span class="c1"># Compatibility</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		The access mode of the connection (&#39;r&#39; or &#39;r+&#39;)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span>

<div class="viewcode-block" id="LoomConnection.last_modified"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.last_modified">[docs]</a>	<span class="k">def</span> <span class="nf">last_modified</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return an ISO8601 timestamp indicating when the file was last modified</span>

<span class="sd">		Returns:</span>
<span class="sd">			An ISO8601 timestamp indicating when the file was last modified</span>

<span class="sd">		Remarks:</span>
<span class="sd">			If the file has no timestamp, and mode is &#39;r+&#39;, a new timestamp is created and returned.</span>
<span class="sd">			Otherwise, the current time in UTC is returned</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="s2">&quot;last_modified&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>
		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="c1"># Make sure the file has modification timestamps</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">()</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;last_modified&quot;</span><span class="p">]</span>
		<span class="k">return</span> <span class="n">timestamp</span><span class="p">()</span></div>

<div class="viewcode-block" id="LoomConnection.get_changes_since"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.get_changes_since">[docs]</a>	<span class="k">def</span> <span class="nf">get_changes_since</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a summary of the parts of the file that changed since the given time</span>

<span class="sd">		Args:</span>
<span class="sd">			timestamp:	ISO8601 timestamp</span>

<span class="sd">		Return:</span>
<span class="sd">			dict:	Dictionary like ``{&quot;row_graphs&quot;: rg, &quot;col_graphs&quot;: cg, &quot;row_attrs&quot;: ra, &quot;col_attrs&quot;: ca, &quot;layers&quot;: layers}`` listing the names of objects that were modified since the given time</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">rg</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">cg</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ra</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">ca</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>

		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">rg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">cg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">ra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">ca</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">last_modified</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">last_modified</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">timestamp</span><span class="p">:</span>
						<span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">{</span><span class="s2">&quot;row_graphs&quot;</span><span class="p">:</span> <span class="n">rg</span><span class="p">,</span> <span class="s2">&quot;col_graphs&quot;</span><span class="p">:</span> <span class="n">cg</span><span class="p">,</span> <span class="s2">&quot;row_attrs&quot;</span><span class="p">:</span> <span class="n">ra</span><span class="p">,</span> <span class="s2">&quot;col_attrs&quot;</span><span class="p">:</span> <span class="n">ca</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span></div>

	<span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Context manager, to support &quot;with loompy.connect(..)&quot; construct</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">traceback</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Context manager, to support &quot;with loompy.connect(..)&quot; construct</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Newly created loom file must be filled with data before leaving the &#39;with&#39; statement&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">_repr_html_</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return an HTML representation of the loom file, showing the upper-left 10x10 corner.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
			<span class="k">return</span> <span class="n">loompy</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="s2">&quot;This LoomConnection has been closed&quot;</span>

	<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Get a slice of the main matrix.</span>

<span class="sd">		Args:</span>
<span class="sd">			slice:		A slice object (see http://docs.h5py.org/en/latest/high/dataset.html), or np.ndarray, or int</span>

<span class="sd">		Returns:</span>
<span class="sd">			A numpy ndarray matrix</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">slice_</span><span class="p">]</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slice must be a 2-tuple&quot;</span><span class="p">)</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">slice_</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Assign a slice of the main matrix.</span>

<span class="sd">		Args:</span>
<span class="sd">			slice_:		A slice object (see http://docs.h5py.org/en/latest/high/dataset.html), or np.ndarray, or int</span>
<span class="sd">			data:		A matrix corresponding to the slice, of the same datatype as the main matrix</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">slice_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">slice_</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">][</span><span class="n">slice_</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

<div class="viewcode-block" id="LoomConnection.sparse"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.sparse">[docs]</a>	<span class="k">def</span> <span class="nf">sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Return the main matrix or specified layer as a scipy.sparse.coo_matrix, without loading dense matrix in RAM</span>

<span class="sd">		Args:</span>
<span class="sd">			rows:		Rows to include, or None to include all</span>
<span class="sd">			cols:		Columns to include, or None to include all</span>
<span class="sd">			layer:		Layer to return, or None to return the default layer</span>

<span class="sd">		Returns:</span>
<span class="sd">			Sparse matrix (:class:`scipy.sparse.coo_matrix`)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">sparse</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.close"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.close">[docs]</a>	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suppress_warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Close the connection. After this, the connection object becomes invalid. Warns user if called after closing.</span>

<span class="sd">		Args:</span>
<span class="sd">			suppress_warning:		Suppresses warning message if True (defaults to false)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_warning</span><span class="p">:</span>
				<span class="c1"># Warn user that they&#39;re being paranoid</span>
				<span class="c1"># and should clean up their code</span>
				<span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Connection to </span><span class="si">%s</span><span class="s2"> is already closed&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: ignore</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span></div>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		True if the connection is closed.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span>

	<span class="k">def</span> <span class="nf">set_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">chunks</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">chunk_cache</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">compression_opts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.layer.Name = matrix` or `ds.layer[`Name`] = matrix` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_layer&#39; is deprecated. Use &#39;ds.layer.Name = matrix&#39; or &#39;ds.layer[&#39;Name&#39;] = matrix&#39; instead&quot;</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>

<div class="viewcode-block" id="LoomConnection.add_columns"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.add_columns">[docs]</a>	<span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add columns of data and attribute values to the dataset.</span>

<span class="sd">		Args:</span>
<span class="sd">			layers (dict or numpy.ndarray or LayerManager):</span>
<span class="sd">				Either:</span>
<span class="sd">				1) A N-by-M matrix of float32s (N rows, M columns) in this case columns are added at the default layer</span>
<span class="sd">				2) A dict {layer_name : matrix} specified so that the matrix (N, M) will be added to layer `layer_name`</span>
<span class="sd">				3) A LayerManager object (such as what is returned by view.layers)</span>
<span class="sd">			col_attrs (dict):</span>
<span class="sd">				Column attributes, where keys are attribute names and values are numpy arrays (float or string) of length M</span>
<span class="sd">			row_attrs (dict):</span>
<span class="sd">				Optional row attributes, where keys are attribute names and values are numpy arrays (float or string) of length M</span>
<span class="sd">			fill_values: dictionary of values to use if a column attribute is missing, or &quot;auto&quot; to fill with zeros or empty strings</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>

<span class="sd">		Notes</span>
<span class="sd">		-----</span>
<span class="sd">		- This will modify the underlying HDF5 file, which will interfere with any concurrent readers.</span>
<span class="sd">		- Column attributes in the file that are NOT provided, will be deleted (unless fill value provided).</span>
<span class="sd">		- Array with Nan should not be provided</span>

<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot add columns when connected in read-only mode&quot;</span><span class="p">)</span>

		<span class="c1"># If this is an empty loom file, just assign the provided row and column attributes, and set the shape</span>
		<span class="n">is_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">row_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;row_attrs must be provided when adding to an empty (new) Loom file&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

		<span class="n">layers_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
		<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
			<span class="n">layers_dict</span> <span class="o">=</span> <span class="n">layers</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid type for layers argument&quot;</span><span class="p">)</span>
		<span class="n">n_cols</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">is_new</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> does not exist in the target loom file&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> has </span><span class="si">{matrix.shape[0]}</span><span class="s2"> rows but file has </span><span class="si">{self.shape[0]}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">n_cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">n_cols</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">elif</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n_cols</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer </span><span class="si">{layer}</span><span class="s2"> has </span><span class="si">{matrix.shape[1]}</span><span class="s2"> columns but the first layer had </span><span class="si">{n_cols}</span><span class="s2">&quot;</span><span class="p">)</span>

		<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fill_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">fill_values</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">fill_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fill_with</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">todel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_cols</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Each column attribute must have exactly </span><span class="si">{n_cols}</span><span class="s2"> values, but </span><span class="si">{key}</span><span class="s2"> had {len(vals)}&quot;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
			<span class="k">del</span> <span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">did_remove</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Some column attributes were removed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">todel</span><span class="p">))</span>

		<span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">False</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">fill_values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">fill_values</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">fill_with</span> <span class="o">=</span> <span class="n">fill_values</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
					<span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fill_with</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">did_remove</span> <span class="o">=</span> <span class="kc">True</span>
					<span class="n">todel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># delete_attr(key, axis=1)</span>
		<span class="k">if</span> <span class="n">did_remove</span><span class="p">:</span>
			<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Some column attributes were removed: &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">todel</span><span class="p">))</span>

		<span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
			<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">n_cols</span> <span class="o">=</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">old_n_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="c1"># Must set new shape here, otherwise the attribute manager will complain</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_cols</span><span class="p">)</span>
			<span class="n">todel</span> <span class="o">=</span> <span class="p">[]</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Removing attribute </span><span class="si">{key}</span><span class="s2"> because shape </span><span class="si">{vals.shape}</span><span class="s2"> did not match existing shape </span><span class="si">{self.col_attrs[key].shape}</span><span class="s2"> beyond first dimension&quot;</span><span class="p">)</span>
					<span class="n">todel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">vals</span><span class="p">])</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">todel</span><span class="p">:</span>
				<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

			<span class="c1"># Add the columns layerwise</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">_resize</span><span class="p">(</span><span class="n">n_cols</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">old_n_cols</span><span class="p">:</span><span class="n">n_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="LoomConnection.add_loom"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.add_loom">[docs]</a>	<span class="k">def</span> <span class="nf">add_loom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">include_graphs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Add the content of another loom file</span>

<span class="sd">		Args:</span>
<span class="sd">			other_file:       filename of the loom file to append</span>
<span class="sd">			key:                    Primary key to use to align rows in the other file with this file</span>
<span class="sd">			fill_values:     default values to use for missing attributes (or None to drop missing attrs, or &#39;auto&#39; to fill with sensible defaults)</span>
<span class="sd">			batch_size:       the batch size used by batchscan (limits the number of rows/columns read in memory)</span>
<span class="sd">			convert_attrs:   convert file attributes that differ between files into column attributes</span>
<span class="sd">			include_graphs:  if true, include all the column graphs from other_file that are also present in this file</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing, but adds the loom file. Note that the other loom file must have exactly the same</span>
<span class="sd">			number of rows, and must have exactly the same column attributes.</span>
<span class="sd">			Adds all the contents including layers but ignores layers in `other_file` that are not already present in self</span>
<span class="sd">			Note that graphs are normally not added, unless include_graphs == True, in which case column graphs are added</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">&quot;r+&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot add data when connected in read-only mode&quot;</span><span class="p">)</span>
		<span class="c1"># Connect to the loom files</span>
		<span class="k">with</span> <span class="n">loompy</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">other_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">other</span><span class="p">:</span>
			<span class="c1"># Verify that the row keys can be aligned</span>
			<span class="n">ordering</span> <span class="o">=</span> <span class="kc">None</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="c1"># This was original Sten&#39;s version but it creates a 400M entries array in memory</span>
				<span class="c1"># ordering = np.where(other.row_attrs[key][None, :] == self.row_attrs[key][:, None])[1]</span>

				<span class="k">def</span> <span class="nf">ixs_thatsort_a2b</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">check_content</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
					<span class="s2">&quot;This is super duper magic sauce to make the order of one list to be like another&quot;</span>
					<span class="k">if</span> <span class="n">check_content</span><span class="p">:</span>
						<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="s2">&quot;The two arrays are not matching&quot;</span>
					<span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">b</span><span class="p">))]</span>

				<span class="n">ordering</span> <span class="o">=</span> <span class="n">ixs_thatsort_a2b</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
				<span class="n">pk1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
				<span class="n">pk2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
				<span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pk1</span><span class="p">):</span>
					<span class="k">if</span> <span class="n">pk2</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
						<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Primary keys are not 1-to-1 alignable!&quot;</span><span class="p">)</span>
			<span class="n">diff_layers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff_layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is missing a layer, cannot merge with current file. layers missing:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">other_file</span><span class="p">,</span> <span class="n">diff_layers</span><span class="p">))</span>

			<span class="k">if</span> <span class="n">convert_attrs</span><span class="p">:</span>
				<span class="c1"># Prepare to replace any global attribute that differ between looms or is missing in either loom with a column attribute.</span>
				<span class="n">globalkeys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="n">globalkeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">globalkeys</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]:</span>
						<span class="k">continue</span>
					<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
						<span class="n">self_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">self_value</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">:</span>
						<span class="n">other_value</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">attrs</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
						<span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">globalkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">other_value</span><span class="p">]</span> <span class="o">*</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="k">if</span> <span class="n">globalkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
						<span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">globalkey</span><span class="p">)</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">batch_scan_layers</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
				<span class="n">ca</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
				<span class="k">if</span> <span class="n">ordering</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">ordering</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="n">fill_values</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
			
			<span class="k">if</span> <span class="n">include_graphs</span><span class="p">:</span>
				<span class="k">for</span> <span class="n">gname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">gname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">:</span>
						<span class="n">g1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">gname</span><span class="p">]</span>
						<span class="n">g2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">gname</span><span class="p">]</span>
						<span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
						<span class="n">m</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
						<span class="n">g3</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">g1</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">g2</span><span class="o">.</span><span class="n">data</span><span class="p">]),</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">g1</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">g2</span><span class="o">.</span><span class="n">row</span> <span class="o">+</span> <span class="n">n</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">g1</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">g2</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="n">n</span><span class="p">]))),</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span><span class="p">))</span>
						<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">gname</span><span class="p">]</span> <span class="o">=</span> <span class="n">g3</span></div>

	<span class="k">def</span> <span class="nf">delete_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `del ds.ra.key` or `del ds.ca.key` instead, where `key` is replaced with the attribute name</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;delete_attr&#39; is deprecated. Use &#39;del ds.ra.key&#39; or &#39;del ds.ca.key&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

	<span class="k">def</span> <span class="nf">set_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.ra.key = values` or `ds.ca.key = values` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_attr&#39; is deprecated. Use &#39;ds.ra.key = values&#39; or &#39;ds.ca.key = values&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

	<span class="k">def</span> <span class="nf">list_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs.keys()` or `ds.col_graphs.keys()` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;list_edges&#39; is deprecated. Use &#39;ds.row_graphs.keys()&#39; or &#39;ds.col_graphs.keys()&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="p">[]</span>

	<span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs[name]` or `ds.col_graphs[name]` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;get_edges&#39; is deprecated. Use &#39;ds.row_graphs[name]&#39; or &#39;ds.col_graphs[name]&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be 0 or 1&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">set_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `ds.row_graphs[name] = g` or `ds.col_graphs[name] = g` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;set_edges&#39; is deprecated. Use &#39;ds.row_graphs[name] = g&#39; or &#39;ds.col_graphs[name] = g&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">g</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">((</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]))</span>
		<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input arrays could not be converted to a sparse matrix&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be 0 (rows) or 1 (columns)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LoomConnection.scan"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.scan">[docs]</a>	<span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="n">what</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;col_attrs&quot;</span><span class="p">,</span> <span class="s2">&quot;row_attrs&quot;</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">,</span> <span class="s2">&quot;col_graphs&quot;</span><span class="p">,</span> <span class="s2">&quot;row_graphs&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Scan across one axis and return batches of rows (columns) as LoomView objects</span>

<span class="sd">		Args</span>
<span class="sd">		----</span>
<span class="sd">		items: np.ndarray</span>
<span class="sd">			the indexes [0, 2, 13, ... ,973] of the rows/cols to include along the axis</span>
<span class="sd">			OR: boolean mask array giving the rows/cols to include</span>
<span class="sd">		axis: int</span>
<span class="sd">			0:rows or 1:cols</span>
<span class="sd">		batch_size: int</span>
<span class="sd">			the chuncks returned at every element of the iterator</span>
<span class="sd">		layers: iterable</span>
<span class="sd">			if specified it will batch scan only across some of the layers of the loom file</span>
<span class="sd">			if layers == None, all layers will be scanned</span>
<span class="sd">			if layers == [&quot;&quot;] or &quot;&quot;, only the default layer will be scanned</span>
<span class="sd">		key:</span>
<span class="sd">			Name of primary key attribute. If specified, return the values sorted by the key</span>

<span class="sd">		Returns</span>
<span class="sd">		------</span>
<span class="sd">		Iterable that yields triplets of (ix, indexes, view) where</span>

<span class="sd">		ix: int</span>
<span class="sd">			first position / how many rows/cols have been yielded alredy</span>
<span class="sd">		indexes: np.ndarray[int]</span>
<span class="sd">			the indexes with the same numbering of the input args cells / genes (i.e. ``np.arange(len(ds.shape[axis]))``)</span>
<span class="sd">			this is ``ix + selection``</span>
<span class="sd">		view: LoomView</span>
<span class="sd">			a view corresponding to the current chunk</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="s2">&quot;layers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Layers must be included in &#39;what&#39; parameter (but you can select specific layers using &#39;layers&#39;)&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must be given (0 = rows, 1 = cols)&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">items</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)):</span>
			<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">items</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

		<span class="n">ordering</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">slice</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="n">vals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># keep everything in original order</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">items</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cols_per_chunk</span><span class="p">:</span>
					<span class="n">selection</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Meaning, select all columns</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">ordering</span><span class="p">,</span> <span class="p">:]</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="n">selection</span><span class="p">]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
				<span class="n">lm</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">lm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
				<span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">ordering</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;row_attrs&quot;</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">else</span> <span class="p">{}</span>
				<span class="k">if</span> <span class="s2">&quot;col_attrs&quot;</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">ca</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">ca</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">ca</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="n">rg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">ordering</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;row_graphs&quot;</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">else</span> <span class="kc">None</span>
				<span class="k">if</span> <span class="s2">&quot;col_graphs&quot;</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">cg</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">rg</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">cols_per_chunk</span><span class="p">),</span> <span class="n">view</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
		<span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># keep everything in original order</span>
				<span class="n">ordering</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">items</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">items</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">rows_per_chunk</span><span class="p">:</span>
					<span class="n">selection</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Meaning, select all rows</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[:,</span> <span class="n">ordering</span><span class="p">]</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
				<span class="n">lm</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="n">lm</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">MemoryLoomLayer</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
				
				<span class="k">if</span> <span class="s2">&quot;row_attrs&quot;</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">ra</span> <span class="o">=</span> <span class="p">{}</span>
				<span class="n">ca</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">ordering</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;col_attrs&quot;</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">else</span> <span class="p">{}</span>
				<span class="k">if</span> <span class="s2">&quot;row_graphs&quot;</span> <span class="ow">in</span> <span class="n">what</span><span class="p">:</span>
					<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
						<span class="n">rg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">]</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">rg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">]</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="n">rg</span> <span class="o">=</span> <span class="kc">None</span>
				<span class="n">cg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="p">[</span><span class="n">ordering</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;col_graphs&quot;</span> <span class="ow">in</span> <span class="n">what</span> <span class="k">else</span> <span class="kc">None</span>
				<span class="n">view</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LoomView</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">rg</span><span class="p">,</span> <span class="n">cg</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rows_per_chunk</span><span class="p">),</span> <span class="n">view</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axis must be 0 or 1&quot;</span><span class="p">)</span></div>

	<span class="k">def</span> <span class="nf">batch_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `scan` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;batch_scan&#39; is deprecated. Use &#39;scan&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layer</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">cells</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">genes</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">selection</span><span class="p">]</span>

				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>

		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">genes</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[:,</span> <span class="n">cells</span><span class="p">]</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>

	<span class="k">def</span> <span class="nf">batch_scan_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Iterable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		**DEPRECATED** - Use `scan` instead</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;batch_scan_layers&#39; is deprecated. Use &#39;scan&#39; instead&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">cells</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">genes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
				<span class="n">cols_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cols_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">cells</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the cells that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">cols_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">cols_per_chunk</span><span class="p">]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">genes</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">selection</span><span class="p">]</span>

				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">cols_per_chunk</span>

		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="n">batch_size</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="k">while</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="n">rows_per_chunk</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ix</span><span class="p">,</span> <span class="n">rows_per_chunk</span><span class="p">)</span>

				<span class="n">selection</span> <span class="o">=</span> <span class="n">genes</span> <span class="o">-</span> <span class="n">ix</span>
				<span class="c1"># Pick out the genes that are in this batch</span>
				<span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">selection</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selection</span> <span class="o">&lt;</span> <span class="n">rows_per_chunk</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
				<span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
					<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>
					<span class="k">continue</span>

				<span class="c1"># Load the whole chunk from the file, then extract genes and cells using fancy indexing</span>
				<span class="n">vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
				<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span> <span class="o">+</span> <span class="n">rows_per_chunk</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span>
					<span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">key</span><span class="p">][:,</span> <span class="n">cells</span><span class="p">]</span>
				<span class="k">yield</span> <span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">selection</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
				<span class="n">ix</span> <span class="o">+=</span> <span class="n">rows_per_chunk</span>

<div class="viewcode-block" id="LoomConnection.map"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.map">[docs]</a>	<span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">int</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Apply a function along an axis without loading the entire dataset in memory.</span>

<span class="sd">		Args:</span>
<span class="sd">			f:		Function(s) that takes a numpy ndarray as argument</span>

<span class="sd">			axis:		Axis along which to apply the function (0 = rows, 1 = columns)</span>

<span class="sd">			chunksize: Number of rows (columns) to load per chunk</span>

<span class="sd">			selection: Columns (rows) to include</span>

<span class="sd">		Returns:</span>
<span class="sd">			numpy.ndarray result of function application</span>
<span class="sd">			The result is a list of numpy arrays, one per supplied function in f_list.</span>
<span class="sd">			This is more efficient than repeatedly calling map() one function at a time.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f_list</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">chunksize</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.permute"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.permute">[docs]</a>	<span class="k">def</span> <span class="nf">permute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ordering</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Permute the dataset along the indicated axis.</span>

<span class="sd">		Args:</span>
<span class="sd">			ordering (list of int): 	The desired order along the axis</span>

<span class="sd">			axis (int):					The axis along which to permute</span>

<span class="sd">		Returns:</span>
<span class="sd">			Nothing.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">(</span><span class="s2">&quot;tiles&quot;</span><span class="p">):</span>
			<span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">[</span><span class="s1">&#39;tiles&#39;</span><span class="p">]</span>

		<span class="n">ordering</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>  <span class="c1"># Flatten the ordering, in case we got a column vector</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">row_graphs</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">col_graphs</span><span class="o">.</span><span class="n">_permute</span><span class="p">(</span><span class="n">ordering</span><span class="p">)</span></div>

<div class="viewcode-block" id="LoomConnection.aggregate"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.aggregate">[docs]</a>	<span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">select</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">group_by</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">aggr_by</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="n">aggr_ca_by</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Aggregate the Loom file by applying aggregation functions to the main matrix as well as to the column attributes</span>

<span class="sd">		Args:</span>
<span class="sd">			out_file	The name of the output Loom file (will be appended to if it exists)</span>
<span class="sd">			select		Bool array giving the columns to include (or None, to include all)</span>
<span class="sd">			group_by	The column attribute to group by, or an np.ndarray of integer group labels</span>
<span class="sd">			aggr_by 	The aggregation function for the main matrix</span>
<span class="sd">			aggr_ca_by	A dictionary of aggregation functions for the column attributes (or None to skip)</span>

<span class="sd">		Returns:</span>
<span class="sd">			m			Aggregated main matrix</span>

<span class="sd">		Remarks:</span>
<span class="sd">			aggr_by gives the aggregation function for the main matrix</span>
<span class="sd">			aggr_ca_by is a dictionary with column attributes as keys and aggregation functionas as values</span>
<span class="sd">			</span>
<span class="sd">			Aggregation functions can be any valid aggregation function from here: https://github.com/ml31415/numpy-groupies</span>

<span class="sd">			In addition, you can specify:</span>
<span class="sd">				&quot;tally&quot; to count the number of occurences of each value of a categorical attribute</span>
<span class="sd">		</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">ca</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># type: Dict[str, np.ndarray]</span>
		<span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The &#39;select&#39; argument is deprecated&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_by</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
			<span class="n">labels</span> <span class="o">=</span> <span class="n">group_by</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">group_by</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">zero_strt_sort_noholes_lbls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
		<span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
		<span class="k">if</span> <span class="n">aggr_ca_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aggr_ca_by</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">func</span> <span class="o">=</span> <span class="n">aggr_ca_by</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
				<span class="k">if</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;tally&quot;</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
						<span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">):</span>
							<span class="n">valnew</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>  <span class="c1"># Slashes are not allowed in attribute names</span>
							<span class="n">valnew</span> <span class="o">=</span> <span class="n">valnew</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>  <span class="c1"># Nor are periods</span>
						<span class="n">ca</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">valnew</span><span class="p">)]</span> <span class="o">=</span> <span class="n">npg</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">zero_strt_sort_noholes_lbls</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span> <span class="n">func</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span>
					<span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>  <span class="c1"># type: ignore</span>
						<span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
					<span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">npg</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">zero_strt_sort_noholes_lbls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
					<span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">npg</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">zero_strt_sort_noholes_lbls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
				<span class="k">elif</span> <span class="n">func</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span><span class="p">:</span>
					<span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">npg</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">zero_strt_sort_noholes_lbls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

		<span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_groups</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]):</span>
			<span class="n">vals_aggr</span> <span class="o">=</span> <span class="n">npg</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">zero_strt_sort_noholes_lbls</span><span class="p">,</span> <span class="n">view</span><span class="p">[:,</span> <span class="p">:],</span> <span class="n">func</span><span class="o">=</span><span class="n">aggr_by</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">m</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">vals_aggr</span>

		<span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">loompy</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">ca</span><span class="p">)</span>

		<span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="LoomConnection.export"><a class="viewcode-back" href="../../fullapi/loompy.html#loompy.LoomConnection.export">[docs]</a>	<span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;tab&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Export the specified layer and row/col attributes as tab-delimited file.</span>

<span class="sd">		Args:</span>
<span class="sd">			out_file:	Path to the output file</span>
<span class="sd">			layer:	Name of the layer to export, or None to export the main matrix</span>
<span class="sd">			format: Desired file format (only &#39;tab&#39; is supported)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="nb">format</span> <span class="o">!=</span> <span class="s2">&quot;tab&quot;</span><span class="p">:</span>
			<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only &#39;tab&#39; is supported&quot;</span><span class="p">)</span>

		<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
			<span class="c1"># Emit column attributes</span>
			<span class="k">for</span> <span class="n">ca</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ca</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_attrs</span><span class="p">[</span><span class="n">ca</span><span class="p">]:</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

			<span class="c1"># Emit row attribute names</span>
			<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ra</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

			<span class="c1"># Emit row attr values and matrix values</span>
			<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
				<span class="k">for</span> <span class="n">ra</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
					<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row_attrs</span><span class="p">[</span><span class="n">ra</span><span class="p">][</span><span class="n">row</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

				<span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="p">:]:</span>
						<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="k">else</span><span class="p">:</span>
					<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][</span><span class="n">row</span><span class="p">,</span> <span class="p">:]:</span>
						<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
				<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">create_append</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fill_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	**DEPRECATED** - Use `new` instead; see https://github.com/linnarsson-lab/loompy/issues/42</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">deprecated</span><span class="p">(</span><span class="s2">&quot;&#39;create_append&#39; is deprecated. See https://github.com/linnarsson-lab/loompy/issues/42&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">add_columns</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="n">fill_values</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">create</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span>


<div class="viewcode-block" id="new"><a class="viewcode-back" href="../../fullapi/new.html#loompy.new">[docs]</a><span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LoomConnection</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create an empty Loom file, and return it as a context manager.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;~/&quot;</span><span class="p">):</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">file_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">file_attrs</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="c1"># Create the file (empty).</span>
	<span class="c1"># Yes, this might cause an exception, which we prefer to send to the caller</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/attrs&#39;</span><span class="p">)</span>  <span class="c1"># v3.0.0</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/layers&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/row_attrs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/col_attrs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/row_graphs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/col_graphs&#39;</span><span class="p">)</span>
	<span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
	<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">file_attrs</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">file_attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_attrs</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span>
	<span class="c1"># store creation date</span>
	<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;CreationDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">()</span>
	<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;LOOM_SPEC_VERSION&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loompy</span><span class="o">.</span><span class="n">loom_spec_version</span>
	<span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="create"><a class="viewcode-back" href="../../fullapi/create.html#loompy.create">[docs]</a><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">],</span> <span class="n">row_attrs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="n">col_attrs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span> <span class="o">*</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a new Loom file from the given data.</span>

<span class="sd">	Args:</span>
<span class="sd">		filename (str):         The filename (typically using a ``.loom`` file extension)</span>
<span class="sd">		layers:					One of the following:</span>

<span class="sd">								* Two-dimensional (N-by-M) numpy ndarray of float values</span>
<span class="sd">								* Sparse matrix (e.g. :class:`scipy.sparse.csr_matrix`)</span>
<span class="sd">								* Dictionary of named layers, each an N-by-M ndarray or sparse matrix</span>
<span class="sd">								* A :class:`.LayerManager`, with each layer an N-by-M ndarray</span>
<span class="sd">		row_attrs (dict):       Row attributes, where keys are attribute names and values</span>
<span class="sd">								are numpy arrays (float or string) of length N</span>
<span class="sd">		col_attrs (dict):       Column attributes, where keys are attribute names and</span>
<span class="sd">								values are numpy arrays (float or string) of length M</span>
<span class="sd">		file_attrs (dict):      Global attributes, where keys are attribute names and</span>
<span class="sd">								values are strings</span>
<span class="sd">	Returns:</span>
<span class="sd">		Nothing</span>

<span class="sd">	Remarks:</span>
<span class="sd">		If the file exists, it will be overwritten.</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row_attrs</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">):</span>
		<span class="n">row_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_attrs</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">AttributeManager</span><span class="p">):</span>
		<span class="n">col_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

	<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">layers</span><span class="p">}</span>
	<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">loompy</span><span class="o">.</span><span class="n">LayerManager</span><span class="p">):</span>
		<span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[:,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
	<span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Data for default layer must be provided&quot;</span><span class="p">)</span>

	<span class="c1"># Sanity checks</span>
	<span class="n">shape</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># type: ignore</span>
	<span class="k">if</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Main matrix cannot be empty&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Layer &#39;</span><span class="si">{name}</span><span class="s2">&#39; is not the same shape as the main matrix&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ra</span> <span class="ow">in</span> <span class="n">row_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Row attribute &#39;</span><span class="si">{name}</span><span class="s2">&#39; is not the same length (</span><span class="si">{ra.shape[0]}</span><span class="s2">) as number of rows in main matrix (</span><span class="si">{shape[0]}</span><span class="s2">)&quot;</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ca</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
			<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Column attribute &#39;</span><span class="si">{name}</span><span class="s2">&#39; is not the same length (</span><span class="si">{ca.shape[0]}</span><span class="s2">) as number of columns in main matrix (</span><span class="si">{shape[1]}</span><span class="s2">)&quot;</span><span class="p">)</span>

	<span class="k">try</span><span class="p">:</span>
		<span class="k">with</span> <span class="n">new</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">layer</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span>
			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">layer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">row_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

			<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="n">ds</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

	<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
			<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">raise</span> <span class="n">ve</span></div>


<div class="viewcode-block" id="create_from_cellranger"><a class="viewcode-back" href="../../fullapi/create_from_cellranger.html#loompy.create_from_cellranger">[docs]</a><span class="k">def</span> <span class="nf">create_from_cellranger</span><span class="p">(</span><span class="n">indir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outdir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">genome</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a .loom file from 10X Genomics cellranger output</span>

<span class="sd">	Args:</span>
<span class="sd">		indir (str):	path to the cellranger output folder (the one that contains &#39;outs&#39;)</span>
<span class="sd">		outdir (str):	output folder wher the new loom file should be saved (default to indir)</span>
<span class="sd">		genome (str):	genome build to load (e.g. &#39;mm10&#39;; if None, determine species from outs folder)</span>

<span class="sd">	Returns:</span>
<span class="sd">		path (str):		Full path to the created loom file.</span>

<span class="sd">	Remarks:</span>
<span class="sd">		The resulting file will be named ``{sampleID}.loom``, where the sampleID is the one given by cellranger.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">outdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">outdir</span> <span class="o">=</span> <span class="n">indir</span>
	<span class="n">sampleid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">indir</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">matrix_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s1">&#39;outs&#39;</span><span class="p">,</span> <span class="s1">&#39;filtered_gene_bc_matrices&#39;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">genome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genome</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
		<span class="n">matrix_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="n">genome</span><span class="p">)</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="n">mmread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
		<span class="n">genelines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;genes.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
		<span class="n">bclines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="k">else</span><span class="p">:</span>  <span class="c1"># cellranger V3 file locations</span>
		<span class="k">if</span> <span class="n">genome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
			<span class="n">genome</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Genome is not visible from V3 folder</span>
		<span class="n">matrix_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s1">&#39;outs&#39;</span><span class="p">,</span> <span class="s1">&#39;filtered_feature_bc_matrix&#39;</span><span class="p">)</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="n">mmread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;matrix.mtx.gz&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
		<span class="n">genelines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;features.tsv.gz&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
		<span class="n">bclines</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">matrix_folder</span><span class="p">,</span> <span class="s2">&quot;barcodes.tsv.gz&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

	<span class="n">accession</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genelines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="n">gene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genelines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="n">cellids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sampleid</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bclines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>

	<span class="n">col_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CellID&quot;</span><span class="p">:</span> <span class="n">cellids</span><span class="p">}</span>
	<span class="n">row_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accession&quot;</span><span class="p">:</span> <span class="n">accession</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">:</span> <span class="n">gene</span><span class="p">}</span>

	<span class="n">tsne_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;tsne&quot;</span><span class="p">,</span> <span class="s2">&quot;projection.csv&quot;</span><span class="p">)</span>
	<span class="c1"># In cellranger V2 the file moved one level deeper</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">):</span>
		<span class="n">tsne_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;tsne&quot;</span><span class="p">,</span> <span class="s2">&quot;2_components&quot;</span><span class="p">,</span> <span class="s2">&quot;projection.csv&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">):</span>
		<span class="n">tsne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">tsne_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsne</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>

	<span class="n">clusters_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="s2">&quot;outs&quot;</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">,</span> <span class="s2">&quot;clustering&quot;</span><span class="p">,</span> <span class="s2">&quot;graphclust&quot;</span><span class="p">,</span> <span class="s2">&quot;clusters.csv&quot;</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">clusters_file</span><span class="p">):</span>
		<span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">clusters_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">col_attrs</span><span class="p">[</span><span class="s2">&quot;ClusterID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

	<span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">sampleid</span> <span class="o">+</span> <span class="s2">&quot;.loom&quot;</span><span class="p">)</span>
	<span class="n">create</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Genome&quot;</span><span class="p">:</span> <span class="n">genome</span><span class="p">})</span>
	<span class="k">return</span> <span class="n">path</span></div>


<span class="k">def</span> <span class="nf">create_from_matrix_market</span><span class="p">(</span><span class="n">out_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">layer_paths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">row_metadata_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_metadata_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delim</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">skip_row_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">skip_colums_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">matrix_transposed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a .loom file from .mtx matrix market format</span>

<span class="sd">	Args:</span>
<span class="sd">		out_file:				path to the newly created .loom file (will be overwritten if it exists)</span>
<span class="sd">		sample_id:				string to use as prefix for cell IDs</span>
<span class="sd">		layer_paths:			dict mapping layer names to paths to the corresponding matrix file (usually with .mtx extension)</span>
<span class="sd">		row_metadata_path:		path to the row (usually genes) metadata file</span>
<span class="sd">		column_metadata_path:	path to the column (usually cells) metadata file</span>
<span class="sd">		delim:					delimiter used for metadata (default: &quot;\t&quot;)</span>
<span class="sd">		skip_row_headers:		if true, skip first line in rows metadata file</span>
<span class="sd">		skip_column_headers: 	if true, skip first line in columns metadata file</span>
<span class="sd">		file_attrs:				dict of global file attributes, or None</span>
<span class="sd">		matrix_transposed:		if true, the main matrix is transposed</span>
<span class="sd">	</span>
<span class="sd">	Remarks:</span>
<span class="sd">		layer_paths should typically map the empty string to a matrix market file: {&quot;&quot;: &quot;path/to/filename.mtx&quot;}.</span>
<span class="sd">		To create a multilayer loom file, map multiple named layers {&quot;&quot;: &quot;path/to/layer1.mtx&quot;, &quot;layer2&quot;: &quot;path/to/layer2.mtx&quot;}</span>
<span class="sd">		Note: the created file MUST have a main layer named &quot;&quot;. If no such layer is given, BUT all given layers are the same</span>
<span class="sd">		datatype, then a main layer will be created as the sum of the other layers. For example, {&quot;spliced&quot;: &quot;spliced.mtx&quot;, &quot;unspliced&quot;: &quot;unspliced.mtx&quot;}</span>
<span class="sd">		will create three layers, &quot;&quot;, &quot;spliced&quot;, and &quot;unspliced&quot;, where &quot;&quot; is the sum of the other two.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">layers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">coo_matrix</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">layer_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="n">mmread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">matrix_transposed</span><span class="p">:</span>
			<span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">T</span>
		<span class="n">layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span>
	<span class="k">if</span> <span class="s2">&quot;&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
		<span class="n">main_matrix</span> <span class="o">=</span> <span class="kc">None</span>
		<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">matrix</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">main_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">main_matrix</span> <span class="o">=</span> <span class="n">matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">main_matrix</span> <span class="o">=</span> <span class="n">main_matrix</span> <span class="o">+</span> <span class="n">matrix</span>
		<span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">main_matrix</span>

	<span class="n">genelines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">row_metadata_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
	<span class="n">bclines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">column_metadata_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

	<span class="n">accession</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genelines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genelines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
		<span class="n">gene</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">genelines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
		<span class="n">row_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accession&quot;</span><span class="p">:</span> <span class="n">accession</span><span class="p">,</span> <span class="s2">&quot;Gene&quot;</span><span class="p">:</span> <span class="n">gene</span><span class="p">}</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">row_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Accession&quot;</span><span class="p">:</span> <span class="n">accession</span><span class="p">}</span>

	<span class="n">cellids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sample_id</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bclines</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
	<span class="n">col_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;CellID&quot;</span><span class="p">:</span> <span class="n">cellids</span><span class="p">}</span>

	<span class="n">create</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">layers</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="n">row_attrs</span><span class="p">,</span> <span class="n">col_attrs</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
		<span class="k">with</span> <span class="n">loompy</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
				<span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
					<span class="k">continue</span>
				<span class="n">ds</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>


<span class="k">def</span> <span class="nf">create_from_kallistobus</span><span class="p">(</span><span class="n">out_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">in_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tr2g_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">whitelist_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Create a loom file from a kallisto-bus output folder.</span>

<span class="sd">	Args:</span>
<span class="sd">		out_file				Full path to the loom file to be created</span>
<span class="sd">		in_dir					Full path to the kallisto-bus directory (containing output.bus, matrix.ec and transcripts.txt)</span>
<span class="sd">		whitelist_file			Full path to the barcode whitelist file (e.g. 10xv2_whitelist.txt)</span>
<span class="sd">		file_attrs				Optional dictionary of global attributes</span>
<span class="sd">		layers					Dict of {layer_name: capture_file_path} to define extra layers</span>
<span class="sd">	&quot;&quot;&quot;</span>

	<span class="k">pass</span>

	<span class="c1"># def import(file: str, key: str)</span>
	<span class="c1"># def demote()</span>
		
<div class="viewcode-block" id="combine"><a class="viewcode-back" href="../../fullapi/combine.html#loompy.combine">[docs]</a><span class="k">def</span> <span class="nf">combine</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Combine two or more loom files and save as a new loom file</span>

<span class="sd">	Args:</span>
<span class="sd">		files (list of str):    the list of input files (full paths)</span>
<span class="sd">		output_file (str):      full path of the output loom file</span>
<span class="sd">		key (string):           Row attribute to use to verify row ordering</span>
<span class="sd">		file_attrs (dict):      file attributes (title, description, url, etc.)</span>
<span class="sd">		batch_size (int):       limits the batch or cols/rows read in memory (default: 1000)</span>
<span class="sd">		convert_attrs (bool):   convert file attributes that differ between files into column attributes</span>

<span class="sd">	Returns:</span>
<span class="sd">		Nothing, but creates a new loom file combining the input files.</span>
<span class="sd">		Note that the loom files must have exactly the same</span>
<span class="sd">		number of rows, and must have exactly the same column attributes.</span>
<span class="sd">		Named layers not present in the first file are discarded.</span>

<span class="sd">		.. warning::</span>
<span class="sd">			If you don&#39;t give a ``key`` argument, the files will be combined without changing</span>
<span class="sd">			the ordering of rows or columns. Row attributes will be taken from the first file.</span>
<span class="sd">			Hence, if rows are not in the same order in all files, the result may be meaningless.</span>

<span class="sd">		To guard against this issue, you are strongly advised to provide a ``key`` argument,</span>
<span class="sd">		which is used to sort files while merging. The ``key`` should be the name of a row</span>
<span class="sd">		attribute that contains a unique value for each row. For example, to order rows by</span>
<span class="sd">		the attribute ``Accession``:</span>

<span class="sd">		.. highlight:: python</span>
<span class="sd">		.. code-block:: python</span>

<span class="sd">			import loompy</span>
<span class="sd">			loompy.combine(files, key=&quot;Accession&quot;)</span>

<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">file_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">file_attrs</span> <span class="o">=</span> <span class="p">{}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input file list was empty&quot;</span><span class="p">)</span>

	<span class="n">copyfile</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output_file</span><span class="p">)</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
	<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">file_attrs</span><span class="p">:</span>
		<span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_attrs</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
			<span class="n">ds</span><span class="o">.</span><span class="n">add_loom</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">convert_attrs</span><span class="o">=</span><span class="n">convert_attrs</span><span class="p">)</span>
	<span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">combine_faster</span><span class="p">(</span><span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">output_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">file_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">selections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skip_attrs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Combine loom files and save as a new loom file</span>

<span class="sd">	Args:</span>
<span class="sd">		files (list of str):    the list of input files (full paths)</span>
<span class="sd">		output_file (str):      full path of the output loom file</span>
<span class="sd">		file_attrs (dict):      file attributes (title, description, url, etc.)</span>
<span class="sd">		selections:				list of indicator arrays (one per file; or None to include all cells for the file) determining which columns to include from each file, or None to include all cells from all files</span>
<span class="sd">		key:					row attribute to use as key for ordering the rows, or None to skip ordering</span>
<span class="sd">		skip_attrs:				list of column attributes that should not be included in the output</span>

<span class="sd">	Returns:</span>
<span class="sd">		Nothing, but creates a new loom file combining the input files.</span>

<span class="sd">		Note that the loom files must have exactly the same</span>
<span class="sd">		number of rows, in exactly the same order, and must have exactly the same column attributes.</span>
<span class="sd">		Values in layers missing from one or more files will be replaced by zeros</span>

<span class="sd">		.. warning::</span>
<span class="sd">			The files will be combined without changing</span>
<span class="sd">			the ordering of rows or columns. Row attributes will be taken from the first file.</span>
<span class="sd">			Hence, if rows are not in the same order in all files, the result may be meaningless.</span>
<span class="sd">	</span>
<span class="sd">	Remarks:</span>
<span class="sd">		This version assumes that the individual files will fit in memory. If you run out of memory, try the standard combine() method.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">if</span> <span class="n">file_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">file_attrs</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="k">if</span> <span class="n">skip_attrs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">skip_attrs</span> <span class="o">=</span> <span class="p">[]</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
		<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input file list was empty&quot;</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">selections</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
		<span class="n">selections</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>  <span class="c1"># None means take all cells from the file</span>

	<span class="n">n_cells</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">n_genes</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">selections</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">loompy</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
			<span class="k">if</span> <span class="n">n_genes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
				<span class="n">n_genes</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="k">elif</span> <span class="n">n_genes</span> <span class="o">!=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
				<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;All files must have exactly the same number of rows, but </span><span class="si">{f}</span><span class="s2"> had </span><span class="si">{ds.shape[0]}</span><span class="s2"> rows while previous files had </span><span class="si">{n_genes}</span><span class="s2">&quot;</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
				<span class="n">n_cells</span> <span class="o">+=</span> <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">n_cells</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

	<span class="n">col_attrs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
	<span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="k">with</span> <span class="n">loompy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">file_attrs</span><span class="o">=</span><span class="n">file_attrs</span><span class="p">)</span> <span class="k">as</span> <span class="n">dsout</span><span class="p">:</span>
		<span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">selections</span><span class="p">):</span>
			<span class="k">with</span> <span class="n">loompy</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
				<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
					<span class="n">ordering</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
				<span class="n">dsout</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">n_cells</span><span class="p">)</span>  <span class="c1"># Not really necessary to set this for each file, but no harm either; needed in order to make sure the first layer added will be the right shape</span>
				<span class="n">n_selected</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
				<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">500_000_000</span> <span class="o">//</span> <span class="n">ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">view</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">what</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">):</span>
					<span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
					<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
						<span class="c1"># Create the layer if it doesn&#39;t exist</span>
						<span class="k">if</span> <span class="n">layer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dsout</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
							<span class="n">dsout</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
						<span class="c1"># Make sure the dtype didn&#39;t change between files</span>
						<span class="k">if</span> <span class="n">dsout</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">ds</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
							<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Each layer must be same datatype in all files, but </span><span class="si">{layer}</span><span class="s2"> of type </span><span class="si">{ds[layer].dtype}</span><span class="s2"> in </span><span class="si">{f}</span><span class="s2"> differs from previous files where it was </span><span class="si">{dsout[layer].dtype}</span><span class="s2">&quot;</span><span class="p">)</span>
						<span class="n">dsout</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">j</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="p">:]</span>
					<span class="n">j</span> <span class="o">+=</span> <span class="n">view</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">ca</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">skip_attrs</span><span class="p">:</span>
						<span class="k">continue</span>
					<span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">col_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">vals</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
							<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Each column attribute must be same datatype in all files, but </span><span class="si">{attr}</span><span class="s2"> is </span><span class="si">{vals.dtype}</span><span class="s2"> in </span><span class="si">{f}</span><span class="s2"> but was </span><span class="si">{col_attrs[attr].dtype}</span><span class="s2"> in previous files&quot;</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
						<span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_cells</span>
						<span class="n">col_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vals</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
					<span class="n">col_attrs</span><span class="p">[</span><span class="n">attr</span><span class="p">][</span><span class="n">ix</span><span class="p">:</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">n_selected</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
				<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">ra</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
					<span class="k">if</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dsout</span><span class="o">.</span><span class="n">ra</span><span class="p">:</span>
						<span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
							<span class="n">dsout</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
						<span class="k">else</span><span class="p">:</span>
							<span class="n">dsout</span><span class="o">.</span><span class="n">ra</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">ordering</span><span class="p">]</span>
			<span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">n_selected</span>
		<span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">col_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
			<span class="n">dsout</span><span class="o">.</span><span class="n">ca</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>


<div class="viewcode-block" id="connect"><a class="viewcode-back" href="../../fullapi/connect.html#loompy.connect">[docs]</a><span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">validate</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">spec_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;3.0.0&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LoomConnection</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Establish a connection to a .loom file.</span>

<span class="sd">	Args:</span>
<span class="sd">		filename:		Path to the Loom file to open</span>
<span class="sd">		mode:			Read/write mode, &#39;r+&#39; (read/write) or &#39;r&#39; (read-only), defaults to &#39;r+&#39;</span>
<span class="sd">		validate:		Validate the file structure against the Loom file format specification</span>
<span class="sd">		spec_version:	The loom file spec version to validate against (e.g. &quot;2.0.1&quot; or &quot;old&quot;)</span>
<span class="sd">	Returns:</span>
<span class="sd">		A LoomConnection instance.</span>

<span class="sd">	Remarks:</span>
<span class="sd">		This function should typically be used as a context manager (i.e. inside a ``with``-block):</span>

<span class="sd">		.. highlight:: python</span>
<span class="sd">		.. code-block:: python</span>

<span class="sd">			import loompy</span>
<span class="sd">			with loompy.connect(&quot;mydata.loom&quot;) as ds:</span>
<span class="sd">				print(ds.ca.keys())</span>

<span class="sd">		This ensures that the file will be closed automatically when the context block ends</span>

<span class="sd">		Note: if validation is requested, an exception is raised if validation fails.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">return</span> <span class="n">LoomConnection</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, LinnarssonLab.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>